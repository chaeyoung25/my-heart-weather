<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë§ˆìŒ ë‚ ì”¨ ì²´í¬ì¸ v3.0</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Gaegu&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="background-blob blob-1"></div>
    <div class="background-blob blob-2"></div>
    <div class="background-blob blob-3"></div>

    <header class="glass-header">
        <div class="logo"><i class="fas fa-heart" style="color:#ff6b6b;"></i> ë§ˆìŒ ë‚ ì”¨</div>
        <button id="btn-admin-mode" class="icon-btn" title="ê´€ë¦¬ì ëª¨ë“œ"><i class="fas fa-lock"></i></button>
    </header>

    <main id="board-container">
        <div class="loading-msg">ì˜¤ëŠ˜ì˜ ë§ˆìŒë“¤ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆì–´ìš”...</div>
    </main>

    <button id="fab-write" class="fab"><i class="fas fa-pen"></i></button>

    <div id="write-modal" class="modal hidden">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h2>ì˜¤ëŠ˜ì˜ ë§ˆìŒ ê¸°ë¡</h2>
                <button class="close-btn" id="close-write">&times;</button>
            </div>
            
            <div class="emotion-grid">
                <button class="emo-btn selected" data-val="â˜€ï¸">â˜€ï¸<br>ë§‘ìŒ</button>
                <button class="emo-btn" data-val="â˜ï¸">â˜ï¸<br>íë¦¼</button>
                <button class="emo-btn" data-val="â˜”">â˜”<br>ìš°ìš¸</button>
                <button class="emo-btn" data-val="â›ˆï¸">â›ˆï¸<br>í­í’</button>
                <button class="emo-btn" data-val="ğŸ¥°">ğŸ¥°<br>í–‰ë³µ</button>
                <button class="emo-btn" data-val="ğŸ¥³">ğŸ¥³<br>ì‹ ë‚¨</button>
                <button class="emo-btn" data-val="ğŸ˜Œ">ğŸ˜Œ<br>í¸ì•ˆ</button>
                <button class="emo-btn" data-val="ğŸ§¸">ğŸ§¸<br>í¬ê·¼</button>
                <button class="emo-btn" data-val="ğŸ˜†">ğŸ˜†<br>ì¦ê±°ì›€</button>
                <button class="emo-btn" data-val="ğŸ˜">ğŸ˜<br>ê¸°ì¨</button>
                <button class="emo-btn" data-val="ğŸ¤©">ğŸ¤©<br>í¥ë¶„</button>
                <button class="emo-btn" data-val="ğŸ’–">ğŸ’–<br>ì¶©ë§Œ</button>
                <button class="emo-btn" data-val="ğŸ¥±">ğŸ¥±<br>í”¼ê³¤</button>
                <button class="emo-btn" data-val="ğŸ¤•">ğŸ¤•<br>ì•„í””</button>
                <button class="emo-btn" data-val="ğŸ¤¯">ğŸ¤¯<br>ë³µì¡</button>
                <button class="emo-btn" data-val="ğŸ˜°">ğŸ˜°<br>ê±±ì •</button>
                <button class="emo-btn" data-val="ğŸ˜¤">ğŸ˜¤<br>ë‹µë‹µ</button>
                <button class="emo-btn" data-val="ğŸ”¥">ğŸ”¥<br>ì—´ì •</button>
                <button class="emo-btn" data-val="âœ¨">âœ¨<br>ì„¤ë ˜</button>
                <button class="emo-btn" data-val="â˜ƒï¸">â˜ƒï¸<br>ì™¸ë¡œì›€</button>
            </div>

            <div class="input-row">
                <input type="text" id="writer-name" class="input-field" placeholder="ë³„ì¹­ (ì´ë¦„)">
                <input type="password" id="writer-pw" class="input-field" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì‚­ì œìš©)" maxlength="4">
            </div>

            <textarea id="post-text" placeholder="ë§ˆìŒì† ì´ì•¼ê¸°ë¥¼ ì ì–´ì£¼ì„¸ìš”..." rows="4"></textarea>
            <button id="submit-post" class="btn-full">ê¸°ë¡í•˜ê¸°</button>
        </div>
    </div>

    <div id="view-modal" class="modal hidden">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <span id="view-emotion" class="detail-emo">â˜€ï¸</span>
                <button id="delete-btn" class="icon-btn delete-icon"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                <button class="close-btn" id="close-view">&times;</button>
            </div>
            <div id="view-author" style="font-size:0.9rem; color:#666; margin-bottom:5px;">ì‘ì„±ì: -</div>
            <p id="view-text" class="detail-text"></p>
            
            <div class="divider"></div>
            
            <div id="comments-list" class="comments-area"></div>
            
            <div class="comment-input-area">
                <input type="text" id="comment-writer" placeholder="ì´ë¦„" style="width: 70px;">
                <input type="password" id="comment-pw" placeholder="ë¹„ë²ˆ" style="width: 60px;">
                <input type="text" id="comment-input" placeholder="ëŒ“ê¸€ ë‚´ìš©" style="flex:1;">
                <button id="submit-comment" class="icon-btn-send"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast hidden">ì•Œë¦¼ ë©”ì‹œì§€</div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyA-gj2lPOdcsAm0B14d5HRFq7E2KDDXEKo",
          authDomain: "heart-weather-1f20a.firebaseapp.com",
          projectId: "heart-weather-1f20a",
          storageBucket: "heart-weather-1f20a.firebasestorage.app",
          messagingSenderId: "665410309658",
          appId: "1:665410309658:web:950106a5d20ff593e64ba3"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ğŸ”” [ì¤‘ìš”] ì•Œë¦¼ ì„¤ì • (ëª©ì‚¬ë‹˜ í° ì„¤ì •ê³¼ ì¼ì¹˜ì‹œí‚´)
        const NOTI_TOPIC = "pastor-heart-weather-v3"; 

        function sendPushNotification(title, message) {
            console.log("ì•Œë¦¼ ì „ì†¡ ì‹œë„:", title); // ë””ë²„ê¹…ìš© ë¡œê·¸
            fetch(`https://ntfy.sh/${NOTI_TOPIC}`, {
                method: 'POST',
                body: message,
                headers: {
                    'Title': title,
                    'Tags': 'heart_decoration', 
                    'Priority': 'default'
                }
            })
            .then(res => console.log("ì•Œë¦¼ ì „ì†¡ ê²°ê³¼:", res.status))
            .catch(err => console.log("ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:", err));
        }

        // ==================================================
        // ê¸°ë³¸ ë³€ìˆ˜ ì„¤ì •
        // ==================================================
        let isAdminMode = false;
        const ADMIN_CODE = "0929"; 

        // ìš”ì†Œë“¤
        const board = document.getElementById('board-container');
        const fab = document.getElementById('fab-write');
        const writeModal = document.getElementById('write-modal');
        const viewModal = document.getElementById('view-modal');
        const toast = document.getElementById('toast');

        // ì˜¤ëŠ˜ ë‚ ì§œ ê³„ì‚° (24ì‹œê°„ ì´ˆê¸°í™” íš¨ê³¼)
        const todayMidnight = new Date();
        todayMidnight.setHours(0, 0, 0, 0);

        // ==================================================
        // ğŸ‘‘ ê´€ë¦¬ì ëª¨ë“œ í† ê¸€ (í—¤ë” ìë¬¼ì‡  ë²„íŠ¼)
        // ==================================================
        const btnAdmin = document.getElementById('btn-admin-mode');
        btnAdmin.addEventListener('click', () => {
            if (!isAdminMode) {
                // ì¼¤ ë•Œ: ì•”í˜¸ í™•ì¸
                const input = prompt("ê´€ë¦¬ì ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
                if (input === ADMIN_CODE) {
                    isAdminMode = true;
                    btnAdmin.classList.add('admin-active'); 
                    btnAdmin.innerHTML = '<i class="fas fa-unlock"></i>'; 
                    showToast("ğŸ‘‘ ê´€ë¦¬ì ëª¨ë“œ ON: ëª¨ë“  ê¸€ì„ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”.");
                    
                    if(!viewModal.classList.contains('hidden')) {
                        document.getElementById('delete-btn').classList.remove('hidden');
                    }
                } else if (input !== null) {
                    alert("ì•”í˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                }
            } else {
                // ëŒ ë•Œ: ê·¸ëƒ¥ êº¼ì§
                isAdminMode = false;
                btnAdmin.classList.remove('admin-active');
                btnAdmin.innerHTML = '<i class="fas fa-lock"></i>'; 
                showToast("ê´€ë¦¬ì ëª¨ë“œ OFF");
            }
        });

        // ==================================================
        // ğŸ“ ê¸€ì“°ê¸°
        // ==================================================
        let selectedEmo = 'â˜€ï¸';
        fab.addEventListener('click', () => {
            writeModal.classList.remove('hidden');
            document.getElementById('writer-name').value = '';
            document.getElementById('writer-pw').value = '';
            document.getElementById('post-text').value = '';
            selectedEmo = 'â˜€ï¸';
            document.querySelectorAll('.emo-btn').forEach(b => b.classList.remove('selected'));
            document.querySelector('[data-val="â˜€ï¸"]').classList.add('selected');
        });

        document.querySelectorAll('.emo-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.emo-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedEmo = btn.dataset.val;
            });
        });

        document.getElementById('close-write').addEventListener('click', () => writeModal.classList.add('hidden'));
        document.getElementById('close-view').addEventListener('click', () => viewModal.classList.add('hidden'));

        // ì €ì¥ (ì•Œë¦¼ ê¸°ëŠ¥ í¬í•¨)
        document.getElementById('submit-post').addEventListener('click', () => {
            const name = document.getElementById('writer-name').value.trim();
            const pw = document.getElementById('writer-pw').value.trim();
            const text = document.getElementById('post-text').value.trim();

            if(!name || !pw || !text) return alert("ë³„ì¹­, ë¹„ë°€ë²ˆí˜¸, ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            // ì €ì¥ ì‹œì‘
            db.collection('posts').add({
                emotion: selectedEmo,
                author: name,
                password: pw, 
                text: text,
                date: firebase.firestore.FieldValue.serverTimestamp(),
                colorIdx: Math.floor(Math.random() * 5)
            }).then(() => {
                writeModal.classList.add('hidden');
                showToast("ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");

                // ğŸ”” ì•Œë¦¼ ë°œì†¡ (ì—¬ê¸°ì„œ ì‹¤í–‰ë¨)
                sendPushNotification("ìƒˆë¡œìš´ ë§ˆìŒ ë‚ ì”¨ ë„ì°©! ğŸ’Œ", "í•™ìƒë“¤ì´ ë§ˆìŒì„ ë‚¨ê²¼ì–´ìš”. ì ‘ì†í•´ì„œ í™•ì¸í•´ë³´ì„¸ìš”!");
            }).catch((error) => {
                console.error("Error writing document: ", error);
                alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        });

        // ==================================================
        // ğŸ‘€ ê¸€ ëª©ë¡ & ìƒì„¸ë³´ê¸°
        // ==================================================
        db.collection('posts')
          .where('date', '>=', todayMidnight) 
          .orderBy('date', 'desc')
          .onSnapshot(snapshot => {
            board.innerHTML = '';
            if (snapshot.empty) {
                board.innerHTML = '<div class="loading-msg" style="grid-column: 1/-1;">ì•„ì§ ì˜¤ëŠ˜ì˜ ë§ˆìŒì´ ì—†ì–´ìš”.<br>ê°€ì¥ ë¨¼ì € ë‚¨ê²¨ë³´ì„¸ìš”!</div>';
                return;
            }
            snapshot.forEach(doc => {
                const data = doc.data();
                const div = document.createElement('div');
                div.className = `post-it color-${data.colorIdx}`;
                div.innerHTML = `
                    <div class="post-emoji">${data.emotion}</div>
                    <div class="post-text">${data.text}</div>
                    <div class="post-author">From. ${data.author}</div>
                `;
                div.addEventListener('click', () => openDetail(doc.id, data));
                board.appendChild(div);
            });
        });

        let currentDocId = null;
        let currentDocData = null;

        function openDetail(id, data) {
            currentDocId = id;
            currentDocData = data;
            
            document.getElementById('view-emotion').textContent = data.emotion;
            document.getElementById('view-text').textContent = data.text;
            document.getElementById('view-author').textContent = `ì‘ì„±ì: ${data.author}`;
            
            viewModal.classList.remove('hidden');
            loadComments(id);
        }

        // ==================================================
        // ğŸ—‘ï¸ ê¸€ ì‚­ì œ
        // ==================================================
        document.getElementById('delete-btn').addEventListener('click', () => {
            if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            if(isAdminMode) {
                db.collection('posts').doc(currentDocId).delete().then(() => {
                    viewModal.classList.add('hidden');
                    showToast("ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.");
                });
                return;
            }

            const inputPw = prompt("ê¸€ ì‘ì„± ì‹œ ì„¤ì •í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if(inputPw === currentDocData.password) {
                db.collection('posts').doc(currentDocId).delete().then(() => {
                    viewModal.classList.add('hidden');
                    showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
            } else if (inputPw !== null) {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!");
            }
        });

        // ==================================================
        // ğŸ’¬ ëŒ“ê¸€ ê¸°ëŠ¥
        // ==================================================
        document.getElementById('submit-comment').addEventListener('click', () => {
            const name = document.getElementById('comment-writer').value.trim();
            const pw = document.getElementById('comment-pw').value.trim();
            const text = document.getElementById('comment-input').value.trim();
            
            if(!name || !pw || !text) return alert("ì´ë¦„, ë¹„ë²ˆ, ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");

            db.collection('posts').doc(currentDocId).collection('comments').add({
                author: name,
                password: pw,
                text: text,
                date: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('comment-input').value = '';
                showToast("ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                
                // ğŸ”” ì•Œë¦¼ ë°œì†¡
                sendPushNotification("ìƒˆ ëŒ“ê¸€ ì•Œë¦¼ ğŸ’¬", "ëˆ„êµ°ê°€ ëŒ“ê¸€ì„ ë‚¨ê²¼ì–´ìš”.");
            });
        });

        function loadComments(postId) {
            const list = document.getElementById('comments-list');
            db.collection('posts').doc(postId).collection('comments').orderBy('date').onSnapshot(shot => {
                list.innerHTML = '';
                shot.forEach(d => {
                    const c = d.data();
                    const div = document.createElement('div');
                    div.className = 'comment-item';
                    
                    div.innerHTML = `
                        <div><span style="font-weight:bold">${c.author}:</span> ${c.text}</div>
                        <i class="fas fa-times" style="color:#ccc; cursor:pointer; margin-left:10px;" onclick="deleteComment('${postId}', '${d.id}', '${c.password}')"></i>
                    `;
                    list.appendChild(div);
                });
            });
        }

        window.deleteComment = function(postId, commentId, commentPw) {
            if(!confirm("ëŒ“ê¸€ì„ ì§€ìš¸ê¹Œìš”?")) return;

            if(isAdminMode) {
                db.collection('posts').doc(postId).collection('comments').doc(commentId).delete().then(()=>{
                    showToast("ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ëŒ“ê¸€ ì‚­ì œë¨");
                });
                return;
            }

            const inputPw = prompt("ëŒ“ê¸€ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥:");
            if(inputPw === commentPw) {
                db.collection('posts').doc(postId).collection('comments').doc(commentId).delete().then(()=>{
                    showToast("ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
            } else if (inputPw !== null) {
                alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜!");
            }
        };

        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>