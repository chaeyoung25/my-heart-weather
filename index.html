<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë§ˆìŒë‚ ì”¨ ì²´í¬ì¸</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Gaegu&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; }
        body { background-color: #f4f7f6; min-height: 100vh; overflow-x: hidden; }
        .background-blob { position: absolute; border-radius: 50%; filter: blur(60px); z-index: -1; opacity: 0.6; }
        .blob-1 { top: -50px; left: -50px; width: 300px; height: 300px; background: #ff9a9e; }
        .blob-2 { bottom: -50px; right: -50px; width: 300px; height: 300px; background: #a18cd1; }
        .blob-3 { top: 40%; left: 30%; width: 200px; height: 200px; background: #fad0c4; }
        .glass-header { position: fixed; top: 0; width: 100%; height: 60px; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.5); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; color: #333; z-index: 100; }
        .logo { font-size: 1.2rem; font-weight: bold; }
        .admin-active { color: #ff6b6b !important; text-shadow: 0 0 5px rgba(255, 107, 107, 0.5); }
        #board-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding: 80px 20px 20px; max-width: 800px; margin: 0 auto; }
        .loading-msg { text-align: center; color: #888; margin-top: 50px; width: 100%; grid-column: 1 / -1; }
        .post-it { padding: 15px; border-radius: 0 0 15px 0; box-shadow: 2px 4px 10px rgba(0,0,0,0.1); cursor: pointer; min-height: 150px; display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.2s; border-top: 1px solid rgba(255,255,255,0.4); }
        .post-it:hover { transform: translateY(-5px); }
        .color-0 { background: #fff4bd; color: #5a4a10; } 
        .color-1 { background: #d4f0f0; color: #1e4a4a; } 
        .color-2 { background: #ffd6e7; color: #5a1e3a; } 
        .color-3 { background: #e2dbf5; color: #3a1e5a; } 
        .color-4 { background: #d4ffd6; color: #1e5a2b; } 
        .post-emoji { font-size: 2rem; margin-bottom: 5px; }
        .post-text { font-size: 0.9rem; line-height: 1.4; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; font-family: 'Gaegu', cursive; margin-bottom: 10px;}
        .post-author { font-size: 0.8rem; font-weight: bold; opacity: 0.8; text-align: right; }
        .glass-card { background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.5); width: 95%; max-width: 400px;}
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(3px); display: flex; justify-content: center; align-items: center; z-index: 200; }
        .hidden { display: none !important; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .emotion-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; max-height: 30vh; overflow-y: auto; padding-right:5px;}
        .emo-btn { background: #f0f0f0; border: none; border-radius: 10px; padding: 10px 0; cursor: pointer; font-size: 0.85rem;}
        .emo-btn.selected { background: #ffeaa7; border: 2px solid #fdcb6e; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-field { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ddd; font-size: 0.95rem; }
        textarea { width: 100%; border: 1px solid #ddd; padding: 10px; border-radius: 10px; resize: none; margin-bottom: 10px; font-family: 'Gaegu', cursive; font-size: 1.1rem; }
        .btn-full { width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: #333; color: white; border: none; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 90; display: flex; justify-content: center; align-items: center; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 1.1rem; color: #333; }
        .delete-icon { color: #ff6b6b; font-size: 0.9rem; border: 1px solid #ff6b6b; padding: 5px 10px; border-radius: 20px; background: white; margin-left: auto; margin-right: 10px; }
        .comments-area { max-height: 200px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 10px; margin: 15px 0; }
        .comment-item { font-size: 0.9rem; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .comment-input-area { display: flex; gap: 5px; }
        #comment-writer, #comment-pw, #comment-input { padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 0.9rem; }
        .icon-btn-send { background: none; border: none; color: #007bff; font-size: 1.2rem; cursor: pointer; padding: 5px; }
        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px; animation: fade 3s forwards; z-index: 300; }
        @keyframes fade { 0% {opacity:0; margin-top:-10px;} 10% {opacity:1; margin-top:0;} 90% {opacity:1;} 100% {opacity:0;} }
    </style>
</head>
<body>
    <div class="background-blob blob-1"></div>
    <div class="background-blob blob-2"></div>
    <div class="background-blob blob-3"></div>

    <header class="glass-header">
        <div class="logo">
            <i class="fas fa-heart" style="color:#ff6b6b;"></i> ë§ˆìŒë‚ ì”¨
        </div>
        <button id="btn-admin-mode" class="icon-btn" title="ê´€ë¦¬ì ëª¨ë“œ"><i class="fas fa-lock"></i></button>
    </header>

    <main id="board-container">
        <div class="loading-msg">ì˜¤ëŠ˜ì˜ ë§ˆìŒë“¤ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆì–´ìš”...</div>
    </main>

    <button id="fab-write" class="fab"><i class="fas fa-pen"></i></button>

    <div id="write-modal" class="modal hidden">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h2>ì˜¤ëŠ˜ì˜ ë§ˆìŒ ê¸°ë¡</h2>
                <button class="close-btn" id="close-write">&times;</button>
            </div>
            
            <div class="emotion-grid">
                <button class="emo-btn selected" data-val="â˜€ï¸">â˜€ï¸<br>ë§‘ìŒ</button>
                <button class="emo-btn" data-val="â˜ï¸">â˜ï¸<br>íë¦¼</button>
                <button class="emo-btn" data-val="â˜”">â˜”<br>ìš°ìš¸</button>
                <button class="emo-btn" data-val="â›ˆï¸">â›ˆï¸<br>í­í’</button>
                <button class="emo-btn" data-val="ğŸ¥°">ğŸ¥°<br>í–‰ë³µ</button>
                <button class="emo-btn" data-val="ğŸ¥³">ğŸ¥³<br>ì‹ ë‚¨</button>
                <button class="emo-btn" data-val="ğŸ˜Œ">ğŸ˜Œ<br>í¸ì•ˆ</button>
                <button class="emo-btn" data-val="ğŸ§¸">ğŸ§¸<br>í¬ê·¼</button>
                <button class="emo-btn" data-val="ğŸ˜†">ğŸ˜†<br>ì¦ê±°ì›€</button>
                <button class="emo-btn" data-val="ğŸ˜">ğŸ˜<br>ê¸°ì¨</button>
                <button class="emo-btn" data-val="ğŸ¤©">ğŸ¤©<br>í¥ë¶„</button>
                <button class="emo-btn" data-val="ğŸ’–">ğŸ’–<br>ì¶©ë§Œ</button>
                <button class="emo-btn" data-val="ğŸ¥±">ğŸ¥±<br>í”¼ê³¤</button>
                <button class="emo-btn" data-val="ğŸ¤•">ğŸ¤•<br>ì•„í””</button>
                <button class="emo-btn" data-val="ğŸ¤¯">ğŸ¤¯<br>ë³µì¡</button>
                <button class="emo-btn" data-val="ğŸ˜°">ğŸ˜°<br>ê±±ì •</button>
                <button class="emo-btn" data-val="ğŸ˜¤">ğŸ˜¤<br>ë‹µë‹µ</button>
                <button class="emo-btn" data-val="ğŸ”¥">ğŸ”¥<br>ì—´ì •</button>
                <button class="emo-btn" data-val="âœ¨">âœ¨<br>ì„¤ë ˜</button>
                <button class="emo-btn" data-val="â˜ƒï¸">â˜ƒï¸<br>ì™¸ë¡œì›€</button>
            </div>

            <div class="input-row">
                <input type="text" id="writer-name" class="input-field" placeholder="ë³„ì¹­ (ì´ë¦„)">
                <input type="password" id="writer-pw" class="input-field" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì‚­ì œìš©)" maxlength="4">
            </div>

            <textarea id="post-text" placeholder="ë§ˆìŒì† ì´ì•¼ê¸°ë¥¼ ì ì–´ì£¼ì„¸ìš”..." rows="4"></textarea>
            <button id="submit-post" class="btn-full">ê¸°ë¡í•˜ê¸°</button>
        </div>
    </div>

    <div id="view-modal" class="modal hidden">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <span id="view-emotion" class="detail-emo">â˜€ï¸</span>
                <button id="delete-btn" class="icon-btn delete-icon"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                <button class="close-btn" id="close-view">&times;</button>
            </div>
            <div id="view-author" style="font-size:0.9rem; color:#666; margin-bottom:5px;">ì‘ì„±ì: -</div>
            <p id="view-text" class="detail-text"></p>
            <div class="divider"></div>
            <div id="comments-list" class="comments-area"></div>
            <div class="comment-input-area">
                <input type="text" id="comment-writer" placeholder="ì´ë¦„" style="width: 70px;">
                <input type="password" id="comment-pw" placeholder="ë¹„ë²ˆ" style="width: 60px;">
                <input type="text" id="comment-input" placeholder="ëŒ“ê¸€ ë‚´ìš©" style="flex:1;">
                <button id="submit-comment" class="icon-btn-send"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast hidden">ì•Œë¦¼ ë©”ì‹œì§€</div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyA-gj2lPOdcsAm0B14d5HRFq7E2KDDXEKo",
          authDomain: "heart-weather-1f20a.firebaseapp.com",
          projectId: "heart-weather-1f20a",
          storageBucket: "heart-weather-1f20a.firebasestorage.app",
          messagingSenderId: "665410309658",
          appId: "1:665410309658:web:950106a5d20ff593e64ba3"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ğŸ”” JSON ë°©ì‹ ì•Œë¦¼ (í•œê¸€ ê¹¨ì§ í•´ê²°)
        function sendPushNotification(title, message) {
            fetch('https://ntfy.sh/', {
                method: 'POST',
                body: JSON.stringify({
                    topic: 'pastor-heart-weather-v3',
                    title: title, 
                    message: message,
                    tags: ['heart_decoration'], 
                    priority: 3
                })
            }).then(() => console.log("ì•Œë¦¼ ì „ì†¡ ì„±ê³µ"))
            .catch(err => console.log("ì•Œë¦¼ ì‹¤íŒ¨:", err));
        }

        let isAdminMode = false;
        const ADMIN_CODE = "0929"; 

        const board = document.getElementById('board-container');
        const fab = document.getElementById('fab-write');
        const writeModal = document.getElementById('write-modal');
        const viewModal = document.getElementById('view-modal');
        const toast = document.getElementById('toast');
        const todayMidnight = new Date();
        todayMidnight.setHours(0, 0, 0, 0);

        const btnAdmin = document.getElementById('btn-admin-mode');
        btnAdmin.addEventListener('click', () => {
            if (!isAdminMode) {
                const input = prompt("ê´€ë¦¬ì ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
                if (input === ADMIN_CODE) {
                    isAdminMode = true;
                    btnAdmin.classList.add('admin-active'); 
                    btnAdmin.innerHTML = '<i class="fas fa-unlock"></i>'; 
                    showToast("ğŸ‘‘ ê´€ë¦¬ì ëª¨ë“œ ON");
                    if(!viewModal.classList.contains('hidden')) document.getElementById('delete-btn').classList.remove('hidden');
                } else if (input !== null) alert("ì•”í˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            } else {
                isAdminMode = false;
                btnAdmin.classList.remove('admin-active');
                btnAdmin.innerHTML = '<i class="fas fa-lock"></i>'; 
                showToast("ê´€ë¦¬ì ëª¨ë“œ OFF");
            }
        });

        let selectedEmo = 'â˜€ï¸';
        fab.addEventListener('click', () => {
            writeModal.classList.remove('hidden');
            document.getElementById('writer-name').value = '';
            document.getElementById('writer-pw').value = '';
            document.getElementById('post-text').value = '';
            selectedEmo = 'â˜€ï¸';
            document.querySelectorAll('.emo-btn').forEach(b => b.classList.remove('selected'));
            document.querySelector('[data-val="â˜€ï¸"]').classList.add('selected');
        });

        document.querySelectorAll('.emo-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.emo-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedEmo = btn.dataset.val;
            });
        });

        document.getElementById('close-write').addEventListener('click', () => writeModal.classList.add('hidden'));
        document.getElementById('close-view').addEventListener('click', () => viewModal.classList.add('hidden'));

        document.getElementById('submit-post').addEventListener('click', () => {
            const name = document.getElementById('writer-name').value.trim();
            const pw = document.getElementById('writer-pw').value.trim();
            const text = document.getElementById('post-text').value.trim();

            if(!name || !pw || !text) return alert("ë³„ì¹­, ë¹„ë°€ë²ˆí˜¸, ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            // 1. ì•Œë¦¼ ì „ì†¡
            sendPushNotification("ìƒˆë¡œìš´ ë§ˆìŒ ë‚ ì”¨ ë„ì°©! ğŸ’Œ", "í•™ìƒë“¤ì´ ë§ˆìŒì„ ë‚¨ê²¼ì–´ìš”. í™•ì¸í•´ë³´ì„¸ìš”!");
            
            writeModal.classList.add('hidden');
            showToast("ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");

            // 2. ì €ì¥ ì‹œë„
            db.collection('posts').add({
                emotion: selectedEmo,
                author: name,
                password: pw, 
                text: text,
                date: firebase.firestore.FieldValue.serverTimestamp(),
                colorIdx: Math.floor(Math.random() * 5)
            }).catch(err => {
                console.log("ì €ì¥ ì‹¤íŒ¨ (ì•Œë¦¼ì€ ê°”ìŒ):", err);
            });
        });

        db.collection('posts')
          .where('date', '>=', todayMidnight) 
          .orderBy('date', 'desc')
          .onSnapshot(snapshot => {
            board.innerHTML = '';
            if (snapshot.empty) {
                board.innerHTML = '<div class="loading-msg" style="grid-column: 1/-1;">ì•„ì§ ì˜¤ëŠ˜ì˜ ë§ˆìŒì´ ì—†ì–´ìš”.<br>ê°€ì¥ ë¨¼ì € ë‚¨ê²¨ë³´ì„¸ìš”!</div>';
                return;
            }
            snapshot.forEach(doc => {
                const data = doc.data();
                const div = document.createElement('div');
                div.className = `post-it color-${data.colorIdx}`;
                div.innerHTML = `
                    <div class="post-emoji">${data.emotion}</div>
                    <div class="post-text">${data.text}</div>
                    <div class="post-author">From. ${data.author}</div>
                `;
                div.addEventListener('click', () => openDetail(doc.id, data));
                board.appendChild(div);
            });
        }, (error) => {
            console.log("ë°ì´í„° ì—ëŸ¬ ë¬´ì‹œ");
        });

        let currentDocId = null;
        let currentDocData = null;

        function openDetail(id, data) {
            currentDocId = id;
            currentDocData = data;
            document.getElementById('view-emotion').textContent = data.emotion;
            document.getElementById('view-text').textContent = data.text;
            document.getElementById('view-author').textContent = `ì‘ì„±ì: ${data.author}`;
            viewModal.classList.remove('hidden');
            loadComments(id);
        }

        document.getElementById('delete-btn').addEventListener('click', () => {
            if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            if(isAdminMode) {
                db.collection('posts').doc(currentDocId).delete().then(() => {
                    viewModal.classList.add('hidden');
                    showToast("ì‚­ì œë¨");
                });
                return;
            }
            const inputPw = prompt("ë¹„ë°€ë²ˆí˜¸:");
            if(inputPw === currentDocData.password) {
                db.collection('posts').doc(currentDocId).delete().then(() => {
                    viewModal.classList.add('hidden');
                    showToast("ì‚­ì œë¨");
                });
            } else if (inputPw !== null) alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
        });

        document.getElementById('submit-comment').addEventListener('click', () => {
            const name = document.getElementById('comment-writer').value.trim();
            const pw = document.getElementById('comment-pw').value.trim();
            const text = document.getElementById('comment-input').value.trim();
            
            if(!name || !pw || !text) return alert("ì…ë ¥ í•„ìš”");

            sendPushNotification("ìƒˆ ëŒ“ê¸€ ì•Œë¦¼ ğŸ’¬", "ëˆ„êµ°ê°€ ëŒ“ê¸€ì„ ë‚¨ê²¼ì–´ìš”.");
            document.getElementById('comment-input').value = '';
            showToast("ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");

            db.collection('posts').doc(currentDocId).collection('comments').add({
                author: name,
                password: pw,
                text: text,
                date: firebase.firestore.FieldValue.serverTimestamp()
            });
        });

        function loadComments(postId) {
            const list = document.getElementById('comments-list');
            db.collection('posts').doc(postId).collection('comments').orderBy('date').onSnapshot(shot => {
                list.innerHTML = '';
                shot.forEach(d => {
                    const c = d.data();
                    const div = document.createElement('div');
                    div.className = 'comment-item';
                    div.innerHTML = `
                        <div><span style="font-weight:bold">${c.author}:</span> ${c.text}</div>
                        <i class="fas fa-times" style="color:#ccc; cursor:pointer; margin-left:10px;" onclick="deleteComment('${postId}', '${d.id}', '${c.password}')"></i>
                    `;
                    list.appendChild(div);
                });
            });
        }

        window.deleteComment = function(postId, commentId, commentPw) {
            if(!confirm("ì‚­ì œ?")) return;
            if(isAdminMode) {
                db.collection('posts').doc(postId).collection('comments').doc(commentId).delete();
                return;
            }
            const inputPw = prompt("ë¹„ë°€ë²ˆí˜¸:");
            if(inputPw === commentPw) {
                db.collection('posts').doc(postId).collection('comments').doc(commentId).delete();
            } else if (inputPw !== null) alert("ì˜¤ë¥˜");
        };

        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>