<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë§ˆìŒë‚ ì”¨ ì²´í¬ì¸</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffb8b8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ë§ˆìŒë‚ ì”¨">
    <link rel="apple-touch-icon" href="icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Gaegu&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* [ë””ìì¸ ì½”ë“œ ìƒëµ ì—†ì´ ì›ë³¸ ìœ ì§€] */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; }
        body { background-color: #f4f7f6; min-height: 100vh; overflow-x: hidden; }
        .background-blob { position: fixed; border-radius: 50%; filter: blur(60px); z-index: -1; opacity: 0.6; }
        .blob-1 { top: -50px; left: -50px; width: 300px; height: 300px; background: #ff9a9e; }
        .blob-2 { bottom: -50px; right: -50px; width: 300px; height: 300px; background: #a18cd1; }
        .glass-header { position: fixed; top: 0; width: 100%; height: 60px; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.5); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 100; }
        .logo { font-size: 1.2rem; font-weight: bold; color: #333; position: relative; }
        .admin-active { color: #ff6b6b !important; text-shadow: 0 0 5px rgba(255, 107, 107, 0.5); }
        .noti-dot { position: absolute; top: -2px; right: -8px; width: 10px; height: 10px; background: #ff4757; border-radius: 50%; border: 2px solid white; display: none; }
        .noti-active { display: block; animation: bounce 1s infinite; }
        #board-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding: 80px 20px 20px; max-width: 800px; margin: 0 auto; }
        .loading-msg { text-align: center; color: #888; margin-top: 50px; grid-column: 1 / -1; }
        .post-it { padding: 15px; border-radius: 0 0 15px 0; box-shadow: 2px 4px 10px rgba(0,0,0,0.1); cursor: pointer; min-height: 150px; display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.2s; border-top: 1px solid rgba(255,255,255,0.4); position: relative; }
        .post-it:hover { transform: translateY(-5px); }
        .notice-tag { position: absolute; top: -10px; left: 10px; background: #6c5ce7; color: white; font-size: 0.75rem; padding: 3px 10px; border-radius: 15px; font-family: 'Gaegu', cursive; z-index: 5; }
        .my-post-tag { position: absolute; top: -5px; right: -5px; background: #333; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; z-index: 10; opacity: 0.8; }
        .comment-badge { background: #ff4757; color: white; font-size: 0.8rem; padding: 3px 8px; border-radius: 20px; margin-top: 5px; text-align: center; font-weight: bold; animation: pulse 2s infinite; display: none; }
        .color-0 { background: #fff4bd; color: #5a4a10; } .color-1 { background: #d4f0f0; color: #1e4a4a; } 
        .color-2 { background: #ffd6e7; color: #5a1e3a; } .color-3 { background: #e2dbf5; color: #3a1e5a; } 
        .color-4 { background: #d4ffd6; color: #1e5a2b; } 
        .post-emoji { font-size: 2rem; margin-bottom: 5px; }
        .post-text { font-size: 0.9rem; line-height: 1.4; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; font-family: 'Gaegu', cursive; margin-bottom: 10px;}
        .post-author { font-size: 0.8rem; font-weight: bold; text-align: right; opacity: 0.7; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: flex-start; z-index: 200; overflow-y: auto; padding: 30px 10px; }
        .modal.show { display: flex; }
        .glass-card { background: #fff; padding: 25px; border-radius: 20px; width: 100%; max-width: 420px; position: relative; margin: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        #install-popup { align-items: center; z-index: 300; }
        .install-card { text-align: center; padding: 30px 25px 15px; border: 2px solid rgba(255, 154, 158, 0.3); }
        .install-icon { font-size: 3.5rem; color: #ff9a9e; margin-bottom: 15px; }
        .install-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 12px; color: #333; }
        #install-desc { font-size: 1rem; color: #444; margin-bottom: 25px; line-height: 1.6; font-family: 'Gaegu', cursive; text-align: center; }
        .install-footer { display: flex; justify-content: center; gap: 15px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 15px; }
        .btn-toggle { background: none; border: none; color: #999; font-size: 0.85rem; cursor: pointer; text-decoration: underline; padding: 5px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: -10px; background: white; z-index: 10; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .notice-body { line-height: 1.8; color: #444; font-size: 0.95rem; word-break: keep-all; white-space: normal; }
        .notice-section { margin: 15px 0; padding: 15px; background: #f0f2f5; border-radius: 12px; border-left: 5px solid #6c5ce7; }
        .notice-section h3 { font-size: 1.05rem; margin-bottom: 10px; color: #333; display: flex; align-items: center; gap: 8px; }
        .notice-item { margin-bottom: 10px; display: flex; gap: 8px; align-items: flex-start; word-break: keep-all; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-field { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; outline: none; }
        textarea { width: 100%; border: 1px solid #ddd; padding: 12px; border-radius: 12px; resize: none; margin-bottom: 10px; font-size: 1.1rem; }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: #333; color: white; border: none; font-size: 1.5rem; cursor: pointer; z-index: 90; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .btn-full { width: 100%; padding: 15px; background: #333; color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .close-btn { background: #eee; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; justify-content: center; align-items: center; }
        .hidden { display: none !important; }
        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px; z-index: 300; display: none; }
        .campaign-text { text-align: center; font-size: 0.85rem; color: #888; font-family: 'Gaegu', cursive; margin-bottom: 8px; margin-top: 5px; }
        .comment-item { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px; font-size: 0.9rem; }
        .comment-content { flex: 1; }
        .comment-actions { display: flex; gap: 8px; margin-left: 10px; opacity: 0.6; }
        .comment-actions i { cursor: pointer; font-size: 0.8rem; }
        .fa-trash { color: #ff6b6b; }
        .fa-pen { color: #00b894; }
        @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-3px);} }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
    </style>
</head>
<body>
    <div class="background-blob blob-1"></div>
    <div class="background-blob blob-2"></div>

    <div id="install-popup" class="modal">
        <div class="glass-card install-card">
            <div class="install-icon"><i class="fas fa-mobile-alt"></i></div>
            <div class="install-title">ë§ˆìŒë‚ ì”¨ë¥¼ ë§¤ì¼ ì‰½ê²Œ ë§Œë‚˜ìš”</div>
            <div id="install-desc">
                ì ì‹œë§Œìš”! í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ì‹œë©´ ë” í¸í•´ìš”.<br><br>
                <div id="device-guide" style="background:#f9f9f9; padding:15px; border-radius:12px; font-family:sans-serif; font-size:0.9rem;">
                    ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>
            <div class="install-footer">
                <button id="btn-hide-today" class="btn-toggle">ì˜¤ëŠ˜ í•˜ë£¨ ì•ˆë³´ê¸°</button>
                <button id="btn-hide-forever" class="btn-toggle">ì•ìœ¼ë¡œ ì•ˆë³´ê¸°</button>
            </div>
            <button class="close-btn" style="position:absolute; top:15px; right:15px;" onclick="closeInstallPopup()">&times;</button>
        </div>
    </div>

    <header class="glass-header">
        <div class="logo">
            <i class="fas fa-heart" style="color:#ff6b6b;"></i> ë§ˆìŒë‚ ì”¨
            <div id="header-noti" class="noti-dot"></div>
        </div>
        <div class="header-right">
            <button id="btn-admin-mode" style="background:none; border:none; cursor:pointer;"><i class="fas fa-lock"></i></button>
        </div>
    </header>

    <main id="board-container">
        <div class="loading-msg">ì˜¤ëŠ˜ì˜ ë§ˆìŒë“¤ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆì–´ìš”...</div>
    </main>

    <button id="fab-write" class="fab"><i class="fas fa-pen"></i></button>

    <div id="write-modal" class="modal">
        <div class="glass-card">
            <div class="modal-header">
                <h2 style="font-size:1.2rem;">ë‚´ ë§ˆìŒì˜ ë‚ ì”¨</h2>
                <button class="close-btn" onclick="closeAllModals()">&times;</button>
            </div>
            <div id="emotion-grid" style="display:grid; grid-template-columns:repeat(5, 1fr); gap:8px; margin-bottom:15px; max-height: 200px; overflow-y: auto;"></div>
            <div class="input-row">
                <input type="text" id="writer-name" class="input-field" placeholder="ë³„ì¹­">
                <input type="password" id="writer-pw" class="input-field" placeholder="ë¹„ë²ˆ(4ì)" maxlength="4">
            </div>
            <textarea id="post-text" placeholder="ë§ˆìŒì† ì´ì•¼ê¸°ë¥¼ ì ì–´ì£¼ì„¸ìš”..." rows="4" style="font-family:'Gaegu', cursive;"></textarea>
            <button id="submit-post" class="btn-full">ê¸°ë¡í•˜ê¸°</button>
        </div>
    </div>

    <div id="view-modal" class="modal">
        <div class="glass-card">
            <div class="modal-header">
                <span id="view-emotion" style="font-size:2rem;">â˜€ï¸</span>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button id="delete-btn" style="color:#ff6b6b; border:1px solid #ff6b6b; background:none; padding:5px 12px; border-radius:20px; font-size:0.85rem; cursor:pointer;"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                    <button class="close-btn" onclick="closeAllModals()">&times;</button>
                </div>
            </div>
            <div id="view-author" style="font-size:0.85rem; color:#888; margin-bottom:15px;">ì‘ì„±ì: -</div>
            <div id="view-content" class="notice-body"></div>
            <div id="comment-section" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                <div id="comments-list" style="max-height:180px; overflow-y:auto; margin-bottom:15px; background:#f9f9f9; padding:10px; border-radius:10px;"></div>
                <div class="campaign-text">
                    <i class="fas fa-smile" style="color:#ffb8b8;"></i> ë”°ëœ»í•œ ëŒ“ê¸€ì´ ìš°ë¦¬ ëª¨ë‘ë¥¼ í–‰ë³µí•˜ê²Œ í•©ë‹ˆë‹¤
                </div>
                <div class="input-row" style="font-size:0.8rem;">
                    <input type="text" id="c-name" placeholder="ì´ë¦„" style="width:60px; padding:10px; border-radius:10px; border:1px solid #ddd;">
                    <input type="password" id="c-pw" placeholder="ë¹„ë²ˆ" style="width:50px; padding:10px; border-radius:10px; border:1px solid #ddd;">
                    <input type="text" id="c-text" placeholder="ë”°ëœ»í•œ ëŒ“ê¸€" style="flex:1; padding:10px; border-radius:10px; border:1px solid #ddd;">
                    <button id="submit-comment" style="border:none; background:none; color:#007bff; cursor:pointer; font-size:1.2rem;"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">ì•Œë¦¼ ë©”ì‹œì§€</div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyA-gj2lPOdcsAm0B14d5HRFq7E2KDDXEKo",
          authDomain: "heart-weather-1f20a.firebaseapp.com",
          projectId: "heart-weather-1f20a",
          storageBucket: "heart-weather-1f20a.firebasestorage.app",
          messagingSenderId: "665410309658",
          appId: "1:665410309658:web:950106a5d20ff593e64ba3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const board = document.getElementById('board-container');
        const writeModal = document.getElementById('write-modal');
        const viewModal = document.getElementById('view-modal');
        const btnAdmin = document.getElementById('btn-admin-mode');
        const todayMidnight = new Date(); todayMidnight.setHours(0, 0, 0, 0);
        const noticeId = "notice-" + todayMidnight.toISOString().split('T')[0];

        let isAdminMode = false;
        let selectedEmo = 'â˜€ï¸';
        let currentDocId = null;
        let currentDocData = null;
        let unsubscribeComments = null;

        // --- ë°±ê·¸ë¼ìš´ë“œ í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œ ë° ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ---
        async function setupNotifications() {
            if (!('serviceWorker' in navigator) || !('Notification' in window)) return;
            
            try {
                // ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
                const reg = await navigator.serviceWorker.register('service-worker.js');
                console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì„±ê³µ');

                // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('ì•Œë¦¼ ê¶Œí•œ í—ˆìš©ë¨');
                }
            } catch (err) {
                console.error('ì„¤ì • ì‹¤íŒ¨:', err);
            }
        }

        // --- PWA ì„¤ì¹˜ ë° ê¸°ê¸° ê°ì§€ ë¡œì§ ---
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches;

        window.addEventListener('load', () => {
            setupNotifications(); // ì•Œë¦¼ ì„¤ì • ì‹¤í–‰
            const hideToday = localStorage.getItem('install_hide_today');
            const hideForever = localStorage.getItem('install_hide_forever');
            const todayStr = new Date().toDateString();

            if (!isStandalone && hideForever !== 'true' && hideToday !== todayStr) {
                setDeviceGuide();
                setTimeout(() => {
                    document.getElementById('install-popup').classList.add('show');
                }, 1500);
            }
        });

        function setDeviceGuide() {
            const guide = document.getElementById('device-guide');
            if (isIOS) {
                guide.innerHTML = "<b>ì•„ì´í° ì„¤ì¹˜ ë°©ë²•:</b><br>1. í•˜ë‹¨ <i class='fas fa-share-square'></i> [ê³µìœ ] ë²„íŠ¼ í´ë¦­<br>2. <i class='fas fa-plus-square'></i> [í™ˆ í™”ë©´ì— ì¶”ê°€] í´ë¦­!";
            } else if (/Android/.test(navigator.userAgent)) {
                guide.innerHTML = "<b>ì•ˆë“œë¡œì´ë“œ ì„¤ì¹˜ ë°©ë²•:</b><br>1. ìš°ì¸¡ ìƒë‹¨ ë©”ë‰´(ì  3ê°œ) í´ë¦­<br>2. [ì•± ì„¤ì¹˜] ë˜ëŠ” [í™ˆ í™”ë©´ ì¶”ê°€] í´ë¦­!";
            } else {
                guide.innerHTML = "<b>PC ì„¤ì¹˜ ë°©ë²•:</b><br>ì£¼ì†Œì°½ ì˜¤ë¥¸ìª½ì˜ [ì„¤ì¹˜] ì•„ì´ì½˜ì´ë‚˜ ë©”ë‰´ì—ì„œ [ì„¤ì¹˜] í´ë¦­!";
            }
        }

        window.closeInstallPopup = function() {
            document.getElementById('install-popup').classList.remove('show');
        };

        document.getElementById('btn-hide-today').onclick = () => {
            localStorage.setItem('install_hide_today', new Date().toDateString());
            closeInstallPopup();
            showToast("ì˜¤ëŠ˜ í•˜ë£¨ ë™ì•ˆ ì´ ì°½ì„ ë„ìš°ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        };

        document.getElementById('btn-hide-forever').onclick = () => {
            if(confirm("ì•ìœ¼ë¡œ ì„¤ì¹˜ ì•ˆë‚´ íŒì—…ì„ ë‹¤ì‹œ ë³´ì§€ ì•Šìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.setItem('install_hide_forever', 'true');
                closeInstallPopup();
                showToast("ì•ìœ¼ë¡œ ì•ˆë‚´ ì°½ì´ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        };

        // ntfy ì•Œë¦¼ ì „ì†¡ (ì´ ë¡œì§ì´ ì„œë²„ë¥¼ í†µí•´ ë‹¤ë¥¸ ì„±ë„ë“¤ì˜ ì„œë¹„ìŠ¤ ì›Œì»¤ë¥¼ ê¹¨ì›ë‹ˆë‹¤)
        function sendPushNotification(title, message) {
            fetch('https://ntfy.sh/pastor-heart-weather-v3', {
                method: 'POST',
                body: message,
                headers: { 'Title': title, 'Priority': 'high', 'Tags': 'heart_decoration' }
            }).catch(err => console.log("ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:", err));
        }

        const NOTICE_HTML = `<p style="margin-bottom:10px;">ì„¸ìƒì˜ ì†ŒìŒì—ì„œ ì ì‹œ ë²—ì–´ë‚˜ ë‚˜ì˜ ë‚´ë©´ì„ ê°€ë§Œíˆ ë§ˆì£¼í•˜ì„¸ìš”. âœ¨</p>`;

        window.closeAllModals = function() {
            writeModal.classList.remove('show');
            viewModal.classList.remove('show');
            document.body.style.overflow = 'auto';
            if (unsubscribeComments) { unsubscribeComments(); unsubscribeComments = null; }
        };

        function openModal(modal) {
            closeAllModals();
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            modal.scrollTop = 0;
        }

        document.getElementById('fab-write').onclick = () => {
            selectedEmo = 'â˜€ï¸';
            document.getElementById('writer-name').value = isAdminMode ? 'ë§ˆìŒë‚ ì”¨' : '';
            document.getElementById('writer-pw').value = isAdminMode ? '0929' : '';
            document.getElementById('post-text').value = '';
            openModal(writeModal);
        };

        const emos = ['â˜€ï¸','â˜ï¸','â˜”','â›ˆï¸','ğŸ¥°','ğŸ¥³','ğŸ˜Œ','ğŸ§¸','ğŸ˜†','ğŸ˜','ğŸ¤©','ğŸ’–','ğŸ¥±','ğŸ¤•','ğŸ¤¯','ğŸ˜°','ğŸ˜¤','ğŸ”¥','âœ¨','â˜ƒï¸'];
        const emoGrid = document.getElementById('emotion-grid');
        emos.forEach(e => {
            const btn = document.createElement('button');
            btn.textContent = e;
            btn.style.cssText = "padding:10px; border:1px solid #eee; background:#fff; border-radius:12px; cursor:pointer; font-size:1.3rem;";
            btn.onclick = () => {
                Array.from(emoGrid.children).forEach(c => c.style.background = '#fff');
                btn.style.background = '#ffeaa7';
                selectedEmo = e;
            };
            emoGrid.appendChild(btn);
        });

        function saveMyPost(docId) {
            let myPosts = JSON.parse(localStorage.getItem('my_posts') || '[]');
            myPosts.push(docId);
            localStorage.setItem('my_posts', JSON.stringify(myPosts));
        }
        function isMyPost(docId) {
            let myPosts = JSON.parse(localStorage.getItem('my_posts') || '[]');
            return myPosts.includes(docId);
        }

        db.collection('posts').where('date', '>=', todayMidnight).orderBy('date', 'desc').onSnapshot(snap => {
            board.innerHTML = '';
            const notice = document.createElement('div');
            notice.className = "post-it color-3";
            notice.innerHTML = `<div class="notice-tag">âœ¨ ë§ˆìŒì˜ ì‰¼í‘œ</div><div class="post-emoji">ğŸŒ±</div><div class="post-text">ë§ˆìŒë‚ ì”¨ ì²´í¬ì¸ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•´ìš”! í´ë¦­í•´ì„œ ì•ˆë‚´ë¬¸ì„ ì½ì–´ë³´ì„¸ìš”.</div><div class="post-author">From. ë§ˆìŒë‚ ì”¨</div>`;
            notice.onclick = () => {
                openModal(viewModal);
                currentDocId = noticeId;
                currentDocData = { isNotice: true, emotion: 'ğŸŒ±', author: 'ë§ˆìŒë‚ ì”¨' };
                document.getElementById('view-emotion').textContent = 'ğŸŒ±';
                document.getElementById('view-author').textContent = 'ì‘ì„±ì: ë§ˆìŒë‚ ì”¨';
                document.getElementById('view-content').innerHTML = NOTICE_HTML;
                document.getElementById('delete-btn').classList.add('hidden');
                document.getElementById('comment-section').classList.remove('hidden');
                loadComments(noticeId);
            };
            board.appendChild(notice);

            snap.forEach(doc => {
                const data = doc.data();
                const post = document.createElement('div');
                post.className = `post-it color-${data.colorIdx}`;
                let myTag = isMyPost(doc.id) ? '<div class="my-post-tag">ë‚´ ê¸€</div>' : '';
                post.innerHTML = `${myTag}<div class="post-emoji">${data.emotion}</div><div class="post-text">${data.text}</div><div class="post-author">From. ${data.author}</div><div id="badge-${doc.id}" class="comment-badge">ğŸ”” ëŒ“ê¸€ ë„ì°©!</div>`;
                post.onclick = () => {
                    openModal(viewModal);
                    currentDocId = doc.id; currentDocData = data;
                    document.getElementById('view-emotion').textContent = data.emotion;
                    document.getElementById('view-author').textContent = `ì‘ì„±ì: ${data.author}`;
                    document.getElementById('view-content').textContent = data.text;
                    document.getElementById('delete-btn').classList.remove('hidden');
                    document.getElementById('comment-section').classList.remove('hidden');
                    if(isAdminMode) {
                        document.getElementById('c-name').value = 'ë§ˆìŒë‚ ì”¨';
                        document.getElementById('c-pw').value = '0929';
                    }
                    loadComments(doc.id); 
                };
                board.appendChild(post);
                if(isMyPost(doc.id)) checkComments(doc.id);
            });
        });

        function checkComments(postId) {
            db.collection('posts').doc(postId).collection('comments').onSnapshot(snap => {
                if(!snap.empty) {
                    const badge = document.getElementById(`badge-${postId}`);
                    if(badge) badge.style.display = 'block';
                    document.getElementById('header-noti').classList.add('noti-active');
                }
            });
        }

        btnAdmin.onclick = () => {
            if (!isAdminMode) {
                const pw = prompt("ê´€ë¦¬ì ì•”í˜¸:");
                if (pw === "0929") {
                    isAdminMode = true;
                    btnAdmin.classList.add('admin-active');
                    showToast("ğŸ‘‘ ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”");
                    if(currentDocId) loadComments(currentDocId); 
                }
            } else {
                isAdminMode = false;
                btnAdmin.classList.remove('admin-active');
                showToast("ê´€ë¦¬ì ëª¨ë“œ í•´ì œ");
                if(currentDocId) loadComments(currentDocId);
            }
        };

        document.getElementById('submit-post').onclick = () => {
            let name = document.getElementById('writer-name').value.trim();
            let pw = document.getElementById('writer-pw').value.trim();
            const text = document.getElementById('post-text').value.trim();
            if(isAdminMode) { name = "ë§ˆìŒë‚ ì”¨"; pw = "0929"; } 
            else {
                if(name === "ë§ˆìŒë‚ ì”¨") return alert("'ë§ˆìŒë‚ ì”¨' ëª…ì¹­ì€ ê´€ë¦¬ì ì „ìš©ì…ë‹ˆë‹¤.");
                if(!name || !pw || !text) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
            if(!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            // ì‹¤ì‹œê°„ ë°±ê·¸ë¼ìš´ë“œ í‘¸ì‹œ ì „ì†¡ (ntfy ê²½ìœ )
            sendPushNotification("ë§ˆìŒ ë‚ ì”¨ ë„ì°© ğŸ’Œ", `${name}ë‹˜ì´ ë”°ëœ»í•œ ë§ˆìŒì„ ë‚¨ê²¼ì–´ìš”!`);

            db.collection('posts').add({
                emotion: selectedEmo, author: name, password: pw, text: text,
                date: firebase.firestore.FieldValue.serverTimestamp(),
                colorIdx: Math.floor(Math.random() * 5)
            }).then((docRef) => { 
                saveMyPost(docRef.id);
                closeAllModals(); showToast("ë§ˆìŒì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨"); 
            });
        };

        document.getElementById('delete-btn').onclick = () => {
            if(!currentDocId || currentDocData.isNotice) return;
            if(!confirm("ì´ ë§ˆìŒ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;
            if(isAdminMode) {
                db.collection('posts').doc(currentDocId).delete().then(() => { closeAllModals(); showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); });
                return;
            }
            const pw = prompt("ë¹„ë°€ë²ˆí˜¸:");
            if(pw === currentDocData.password) {
                db.collection('posts').doc(currentDocId).delete().then(() => { closeAllModals(); showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); });
            } else if(pw !== null) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
        };

        document.getElementById('submit-comment').onclick = () => {
            let name = document.getElementById('c-name').value.trim();
            let pw = document.getElementById('c-pw').value.trim();
            const text = document.getElementById('c-text').value.trim();
            if(isAdminMode) { name = "ë§ˆìŒë‚ ì”¨"; pw = "0929"; } 
            else {
                if(name === "ë§ˆìŒë‚ ì”¨") return alert("'ë§ˆìŒë‚ ì”¨' ëª…ì¹­ì€ ê´€ë¦¬ì ì „ìš©ì…ë‹ˆë‹¤.");
                if(!name || !pw || !text) return alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
            if(!text) return alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            // ëŒ“ê¸€ ì•Œë¦¼ ì „ì†¡
            sendPushNotification("ë”°ëœ»í•œ ì‘ì› ë„ì°© â¤ï¸", `${name}ë‹˜ì´ ë‚´ ê¸€ì— ëŒ“ê¸€ì„ ë‚¨ê²¼ì–´ìš”!`);

            db.collection('posts').doc(currentDocId).collection('comments').add({
                author: name, password: pw, text: text,
                date: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('c-text').value = '';
                showToast("ë”°ëœ»í•œ ì‘ì›ì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤! â¤ï¸");
            });
        };

        function loadComments(id) {
            if (unsubscribeComments) unsubscribeComments(); 
            const list = document.getElementById('comments-list');
            list.innerHTML = ''; 
            unsubscribeComments = db.collection('posts').doc(id).collection('comments').orderBy('date').onSnapshot(snap => {
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<p style="text-align:center; color:#ccc; font-size:0.85rem;">ì²« ì‘ì›ì˜ ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”.</p>'; return; }
                snap.forEach(d => {
                    const c = d.data();
                    const div = document.createElement('div');
                    div.className = 'comment-item';
                    let buttons = isAdminMode ? `<i class="fas fa-trash" onclick="adminDeleteComment('${d.id}')"></i>` : `
                        <i class="fas fa-pen" onclick="editComment('${d.id}', '${c.password}', '${c.text}')"></i>
                        <i class="fas fa-trash" onclick="userDeleteComment('${d.id}', '${c.password}')"></i>
                    `;
                    div.innerHTML = `<div class="comment-content"><b>${c.author}:</b> <span id="text-${d.id}">${c.text}</span></div><div class="comment-actions">${buttons}</div>`;
                    list.appendChild(div);
                });
            });
        }

        window.editComment = function(commentId, originalPw, originalText) {
            const inputPw = prompt("ëŒ“ê¸€ ë¹„ë°€ë²ˆí˜¸:");
            if (inputPw === originalPw) {
                const newText = prompt("ìˆ˜ì •í•  ë‚´ìš©:", originalText);
                if (newText && newText.trim() !== "") {
                    db.collection('posts').doc(currentDocId).collection('comments').doc(commentId).update({ text: newText }).then(() => showToast("ëŒ“ê¸€ ìˆ˜ì •ë¨"));
                }
            } else if (inputPw !== null) alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
        };

        window.userDeleteComment = function(commentId, originalPw) {
            const inputPw = prompt("ëŒ“ê¸€ ë¹„ë°€ë²ˆí˜¸:");
            if (inputPw === originalPw) {
                if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    db.collection('posts').doc(currentDocId).collection('comments').doc(commentId).delete().then(() => showToast("ëŒ“ê¸€ ì‚­ì œë¨"));
                }
            } else if (inputPw !== null) alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
        };

        window.adminDeleteComment = function(commentId) {
            if(confirm("ê´€ë¦¬ì ê¶Œí•œ ì‚­ì œ?")) {
                db.collection('posts').doc(currentDocId).collection('comments').doc(commentId).delete().then(() => showToast("ê´€ë¦¬ì ì‚­ì œì™„ë£Œ"));
            }
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }
    </script>
</body>
</html>