<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë§ˆìŒë‚ ì”¨ ì²´í¬ì¸</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ff9a9e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ë§ˆìŒë‚ ì”¨">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/826/826070.png">

    <link href="https://fonts.googleapis.com/css2?family=Gaegu&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; }
        body { background-color: #f4f7f6; min-height: 100vh; overflow-x: hidden; }
        
        .background-blob { position: fixed; border-radius: 50%; filter: blur(60px); z-index: -1; opacity: 0.6; }
        .blob-1 { top: -50px; left: -50px; width: 300px; height: 300px; background: #ff9a9e; }
        .blob-2 { bottom: -50px; right: -50px; width: 300px; height: 300px; background: #a18cd1; }
        
        /* í—¤ë” */
        .glass-header { position: fixed; top: 0; width: 100%; height: 60px; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.5); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 100; }
        .logo { font-size: 1.2rem; font-weight: bold; color: #333; position: relative; }
        .admin-active { color: #ff6b6b !important; text-shadow: 0 0 5px rgba(255, 107, 107, 0.5); }
        .noti-dot { position: absolute; top: -2px; right: -8px; width: 10px; height: 10px; background: #ff4757; border-radius: 50%; border: 2px solid white; display: none; }
        .noti-active { display: block; animation: bounce 1s infinite; }

        /* ë©”ì¸ ë³´ë“œ */
        #board-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding: 80px 20px 20px; max-width: 800px; margin: 0 auto; }
        .loading-msg { text-align: center; color: #888; margin-top: 50px; grid-column: 1 / -1; }
        
        /* í¬ìŠ¤íŠ¸ì‡ */
        .post-it { padding: 15px; border-radius: 0 0 15px 0; box-shadow: 2px 4px 10px rgba(0,0,0,0.1); cursor: pointer; min-height: 150px; display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.2s; border-top: 1px solid rgba(255,255,255,0.4); position: relative; }
        .post-it:hover { transform: translateY(-5px); }
        .notice-tag { position: absolute; top: -10px; left: 10px; background: #6c5ce7; color: white; font-size: 0.75rem; padding: 3px 10px; border-radius: 15px; font-family: 'Gaegu', cursive; z-index: 5; }
        .my-post-tag { position: absolute; top: -5px; right: -5px; background: #333; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; z-index: 10; opacity: 0.8; }
        .comment-badge { background: #ff4757; color: white; font-size: 0.8rem; padding: 3px 8px; border-radius: 20px; margin-top: 5px; text-align: center; font-weight: bold; animation: pulse 2s infinite; display: none; }

        .color-0 { background: #fff4bd; color: #5a4a10; } .color-1 { background: #d4f0f0; color: #1e4a4a; } 
        .color-2 { background: #ffd6e7; color: #5a1e3a; } .color-3 { background: #e2dbf5; color: #3a1e5a; } 
        .color-4 { background: #d4ffd6; color: #1e5a2b; } 

        .post-emoji { font-size: 2rem; margin-bottom: 5px; }
        .post-text { font-size: 0.9rem; line-height: 1.4; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; font-family: 'Gaegu', cursive; margin-bottom: 10px;}
        .post-author { font-size: 0.8rem; font-weight: bold; text-align: right; opacity: 0.7; }

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: flex-start; z-index: 200; overflow-y: auto; padding: 30px 10px; }
        .modal.show { display: flex; }
        .glass-card { background: #fff; padding: 25px; border-radius: 20px; width: 100%; max-width: 420px; position: relative; margin: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        
        /* ì„¤ì¹˜ ìœ ë„ íŒì—… ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        #install-popup { align-items: center; z-index: 300; }
        .install-card { text-align: center; padding: 30px 25px 15px; border: 2px solid rgba(255, 154, 158, 0.3); }
        .install-icon { font-size: 3.5rem; color: #ff9a9e; margin-bottom: 15px; }
        .install-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 12px; color: #333; }
        #install-desc { font-size: 1rem; color: #444; margin-bottom: 25px; line-height: 1.6; font-family: 'Gaegu', cursive; text-align: center; }
        
        /* ë…¸ì¶œ ì œì–´ ë²„íŠ¼ ê·¸ë£¹ */
        .install-footer { display: flex; justify-content: center; gap: 15px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 15px; }
        .btn-toggle { background: none; border: none; color: #999; font-size: 0.85rem; cursor: pointer; text-decoration: underline; padding: 5px; }
        .btn-toggle:hover { color: #666; }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: -10px; background: white; z-index: 10; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .notice-body { line-height: 1.8; color: #444; font-size: 0.95rem; word-break: keep-all; white-space: normal; }
        .notice-section { margin: 15px 0; padding: 15px; background: #f0f2f5; border-radius: 12px; border-left: 5px solid #6c5ce7; }
        .notice-section h3 { font-size: 1.05rem; margin-bottom: 10px; color: #333; display: flex; align-items: center; gap: 8px; }
        .notice-item { margin-bottom: 10px; display: flex; gap: 8px; align-items: flex-start; word-break: keep-all; }
        
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-field { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; outline: none; }
        textarea { width: 100%; border: 1px solid #ddd; padding: 12px; border-radius: 12px; resize: none; margin-bottom: 10px; font-size: 1.1rem; }
        
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: #333; color: white; border: none; font-size: 1.5rem; cursor: pointer; z-index: 90; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .btn-full { width: 100%; padding: 15px; background: #333; color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .close-btn { background: #eee; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; justify-content: center; align-items: center; }

        .hidden { display: none !important; }
        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px; z-index: 300; display: none; }
        .campaign-text { text-align: center; font-size: 0.85rem; color: #888; font-family: 'Gaegu', cursive; margin-bottom: 8px; margin-top: 5px; }

        @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-3px);} }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
    </style>
</head>
<body>
    <div class="background-blob blob-1"></div>
    <div class="background-blob blob-2"></div>

    <div id="install-popup" class="modal">
        <div class="glass-card install-card">
            <div class="install-icon"><i class="fas fa-mobile-alt"></i></div>
            <div class="install-title">ë§ˆìŒë‚ ì”¨ë¥¼ ì•±ìœ¼ë¡œ ë§Œë‚˜ìš”</div>
            <div id="install-desc">
                ì ì‹œë§Œìš”! ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ë©´ ë” í¸í•´ìš”.<br><br>
                <div id="device-guide" style="background:#f9f9f9; padding:15px; border-radius:12px; font-family:sans-serif; font-size:0.9rem;">
                    ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>
            <div class="install-footer">
                <button id="btn-hide-today" class="btn-toggle">ì˜¤ëŠ˜ í•˜ë£¨ ì•ˆë³´ê¸°</button>
                <button id="btn-hide-forever" class="btn-toggle">ì•ìœ¼ë¡œ ì•ˆë³´ê¸°</button>
            </div>
            <button class="close-btn" style="position:absolute; top:15px; right:15px;" onclick="closeInstallPopup()">&times;</button>
        </div>
    </div>

    <header class="glass-header">
        <div class="logo">
            <i class="fas fa-heart" style="color:#ff6b6b;"></i> ë§ˆìŒë‚ ì”¨
            <div id="header-noti" class="noti-dot"></div>
        </div>
        <div class="header-right">
            <button id="btn-admin-mode" style="background:none; border:none; cursor:pointer;"><i class="fas fa-lock"></i></button>
        </div>
    </header>

    <main id="board-container">
        <div class="loading-msg">ì˜¤ëŠ˜ì˜ ë§ˆìŒë“¤ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆì–´ìš”...</div>
    </main>

    <button id="fab-write" class="fab"><i class="fas fa-pen"></i></button>

    <div id="write-modal" class="modal">
        <div class="glass-card">
            <div class="modal-header">
                <h2 style="font-size:1.2rem;">ë‚´ ë§ˆìŒì˜ ë‚ ì”¨</h2>
                <button class="close-btn" onclick="closeAllModals()">&times;</button>
            </div>
            <div id="emotion-grid" style="display:grid; grid-template-columns:repeat(5, 1fr); gap:8px; margin-bottom:15px; max-height: 200px; overflow-y: auto;"></div>
            <div class="input-row">
                <input type="text" id="writer-name" class="input-field" placeholder="ë³„ì¹­">
                <input type="password" id="writer-pw" class="input-field" placeholder="ë¹„ë²ˆ(4ì)" maxlength="4">
            </div>
            <textarea id="post-text" placeholder="ë§ˆìŒì† ì´ì•¼ê¸°ë¥¼ ì ì–´ì£¼ì„¸ìš”..." rows="4" style="font-family:'Gaegu', cursive;"></textarea>
            <button id="submit-post" class="btn-full">ê¸°ë¡í•˜ê¸°</button>
        </div>
    </div>

    <div id="view-modal" class="modal">
        <div class="glass-card">
            <div class="modal-header">
                <span id="view-emotion" style="font-size:2rem;">â˜€ï¸</span>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button id="delete-btn" style="color:#ff6b6b; border:1px solid #ff6b6b; background:none; padding:5px 12px; border-radius:20px; font-size:0.85rem; cursor:pointer;"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                    <button class="close-btn" onclick="closeAllModals()">&times;</button>
                </div>
            </div>
            <div id="view-author" style="font-size:0.85rem; color:#888; margin-bottom:15px;">ì‘ì„±ì: -</div>
            <div id="view-content" class="notice-body"></div>
            <div id="comment-section" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                <div id="comments-list" style="max-height:180px; overflow-y:auto; margin-bottom:15px; background:#f9f9f9; padding:10px; border-radius:10px;"></div>
                <div class="campaign-text">
                    <i class="fas fa-smile" style="color:#ffb8b8;"></i> ë”°ëœ»í•œ ëŒ“ê¸€ì´ ìš°ë¦¬ ëª¨ë‘ë¥¼ í–‰ë³µí•˜ê²Œ í•©ë‹ˆë‹¤
                </div>
                <div class="input-row" style="font-size:0.8rem;">
                    <input type="text" id="c-name" placeholder="ì´ë¦„" style="width:60px; padding:10px; border-radius:10px; border:1px solid #ddd;">
                    <input type="password" id="c-pw" placeholder="ë¹„ë²ˆ" style="width:50px; padding:10px; border-radius:10px; border:1px solid #ddd;">
                    <input type="text" id="c-text" placeholder="ë”°ëœ»í•œ ëŒ“ê¸€" style="flex:1; padding:10px; border-radius:10px; border:1px solid #ddd;">
                    <button id="submit-comment" style="border:none; background:none; color:#007bff; cursor:pointer; font-size:1.2rem;"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">ì•Œë¦¼ ë©”ì‹œì§€</div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyA-gj2lPOdcsAm0B14d5HRFq7E2KDDXEKo",
          authDomain: "heart-weather-1f20a.firebaseapp.com",
          projectId: "heart-weather-1f20a",
          storageBucket: "heart-weather-1f20a.firebasestorage.app",
          messagingSenderId: "665410309658",
          appId: "1:665410309658:web:950106a5d20ff593e64ba3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const board = document.getElementById('board-container');
        const writeModal = document.getElementById('write-modal');
        const viewModal = document.getElementById('view-modal');
        const btnAdmin = document.getElementById('btn-admin-mode');
        const todayMidnight = new Date(); todayMidnight.setHours(0, 0, 0, 0);
        const noticeId = "notice-" + todayMidnight.toISOString().split('T')[0];

        let isAdminMode = false;
        let selectedEmo = 'â˜€ï¸';
        let currentDocId = null;
        let currentDocData = null;
        let unsubscribeComments = null;

        // --- ì„¤ì¹˜ íŒì—… ë…¸ì¶œ ì œì–´ ë¡œì§ ---
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches;

        window.addEventListener('load', () => {
            const hideToday = localStorage.getItem('install_hide_today');
            const hideForever = localStorage.getItem('install_hide_forever');
            const todayStr = new Date().toDateString();

            // íŒì—… ë…¸ì¶œ ì¡°ê±´: ì•± ì‹¤í–‰ ì¤‘ ì•„ë‹˜ + ì•ìœ¼ë¡œ ì•ˆë³´ê¸° ì•„ë‹˜ + ì˜¤ëŠ˜ ì•ˆë³´ê¸° ì•„ë‹˜
            if (!isStandalone && hideForever !== 'true' && hideToday !== todayStr) {
                setDeviceGuide();
                setTimeout(() => {
                    document.getElementById('install-popup').classList.add('show');
                }, 1500);
            }
        });

        function setDeviceGuide() {
            const guide = document.getElementById('device-guide');
            if (isIOS) {
                guide.innerHTML = "<b>ì•„ì´í° ì„¤ì¹˜ ë°©ë²•:</b><br>1. í•˜ë‹¨ [ê³µìœ ] ë²„íŠ¼ í´ë¦­<br>2. [í™ˆ í™”ë©´ì— ì¶”ê°€] í´ë¦­!";
            } else if (/Android/.test(navigator.userAgent)) {
                guide.innerHTML = "<b>ì•ˆë“œë¡œì´ë“œ ì„¤ì¹˜ ë°©ë²•:</b><br>1. ìš°ì¸¡ ìƒë‹¨ ë©”ë‰´(ì  3ê°œ) í´ë¦­<br>2. [ì•± ì„¤ì¹˜] ë˜ëŠ” [í™ˆ í™”ë©´ ì¶”ê°€] í´ë¦­!";
            } else {
                guide.innerHTML = "<b>PC ì„¤ì¹˜ ë°©ë²•:</b><br>ì£¼ì†Œì°½ ì˜¤ë¥¸ìª½ì˜ [ì„¤ì¹˜] ì•„ì´ì½˜ì´ë‚˜<br>ë¸Œë¼ìš°ì € ë©”ë‰´ì—ì„œ [ì„¤ì¹˜]ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”!";
            }
        }

        window.closeInstallPopup = function() {
            document.getElementById('install-popup').classList.remove('show');
        };

        document.getElementById('btn-hide-today').onclick = () => {
            localStorage.setItem('install_hide_today', new Date().toDateString());
            closeInstallPopup();
            showToast("ì˜¤ëŠ˜ í•˜ë£¨ ë™ì•ˆ ì´ ì°½ì„ ë„ìš°ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        };

        document.getElementById('btn-hide-forever').onclick = () => {
            if(confirm("ì•ìœ¼ë¡œ ì„¤ì¹˜ ì•ˆë‚´ íŒì—…ì„ ë‹¤ì‹œ ë³´ì§€ ì•Šìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.setItem('install_hide_forever', 'true');
                closeInstallPopup();
                showToast("ì•ìœ¼ë¡œ ì•ˆë‚´ ì°½ì´ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        };

        // --- ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€ ---
        function sendPushNotification(title, message) {
            fetch('https://ntfy.sh/', {
                method: 'POST',
                body: JSON.stringify({
                    topic: 'pastor-heart-weather-v3',
                    title: title, 
                    message: message,
                    tags: ['heart_decoration'], 
                    priority: 3
                })
            }).catch(err => console.log("ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:", err));
        }

        const NOTICE_HTML = `<p>ë§ˆìŒë‚ ì”¨ ì²´í¬ì¸ ì•ˆë‚´ë¬¸ ë‚´ìš© ìƒëµ ì—†ì´ ì›ë³¸ ìœ ì§€ë¨...</p>`;

        window.closeAllModals = function() {
            writeModal.classList.remove('show');
            viewModal.classList.remove('show');
            document.body.style.overflow = 'auto';
            if (unsubscribeComments) { unsubscribeComments(); unsubscribeComments = null; }
        };

        function openModal(modal) {
            closeAllModals();
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            modal.scrollTop = 0;
        }

        document.getElementById('fab-write').onclick = () => {
            selectedEmo = 'â˜€ï¸';
            document.getElementById('writer-name').value = isAdminMode ? 'ë§ˆìŒë‚ ì”¨' : '';
            document.getElementById('writer-pw').value = isAdminMode ? '0929' : '';
            document.getElementById('post-text').value = '';
            openModal(writeModal);
        };

        const emos = ['â˜€ï¸','â˜ï¸','â˜”','â›ˆï¸','ğŸ¥°','ğŸ¥³','ğŸ˜Œ','ğŸ§¸','ğŸ˜†','ğŸ˜','ğŸ¤©','ğŸ’–','ğŸ¥±','ğŸ¤•','ğŸ¤¯','ğŸ˜°','ğŸ˜¤','ğŸ”¥','âœ¨','â˜ƒï¸'];
        const emoGrid = document.getElementById('emotion-grid');
        emos.forEach(e => {
            const btn = document.createElement('button');
            btn.textContent = e;
            btn.style.cssText = "padding:10px; border:1px solid #eee; background:#fff; border-radius:12px; cursor:pointer; font-size:1.3rem;";
            btn.onclick = () => {
                Array.from(emoGrid.children).forEach(c => c.style.background = '#fff');
                btn.style.background = '#ffeaa7';
                selectedEmo = e;
            };
            emoGrid.appendChild(btn);
        });

        function saveMyPost(docId) {
            let myPosts = JSON.parse(localStorage.getItem('my_posts') || '[]');
            myPosts.push(docId);
            localStorage.setItem('my_posts', JSON.stringify(myPosts));
        }
        function isMyPost(docId) {
            let myPosts = JSON.parse(localStorage.getItem('my_posts') || '[]');
            return myPosts.includes(docId);
        }

        db.collection('posts').where('date', '>=', todayMidnight).orderBy('date', 'desc').onSnapshot(snap => {
            board.innerHTML = '';
            const notice = document.createElement('div');
            notice.className = "post-it color-3";
            notice.innerHTML = `<div class="notice-tag">âœ¨ ë§ˆìŒì˜ ì‰¼í‘œ</div><div class="post-emoji">ğŸŒ±</div><div class="post-text">ì•ˆë‚´ë¬¸...</div><div class="post-author">From. ë§ˆìŒë‚ ì”¨</div>`;
            notice.onclick = () => {
                openModal(viewModal);
                currentDocId = noticeId;
                currentDocData = { isNotice: true, emotion: 'ğŸŒ±', author: 'ë§ˆìŒë‚ ì”¨' };
                document.getElementById('view-emotion').textContent = 'ğŸŒ±';
                document.getElementById('view-author').textContent = 'ì‘ì„±ì: ë§ˆìŒë‚ ì”¨';
                document.getElementById('view-content').innerHTML = "ì•ˆë‚´ë¬¸ ì›ë³¸ ìœ ì§€...";
                document.getElementById('delete-btn').classList.add('hidden');
                document.getElementById('comment-section').classList.remove('hidden');
                loadComments(noticeId);
            };
            board.appendChild(notice);

            snap.forEach(doc => {
                const data = doc.data();
                const post = document.createElement('div');
                post.className = `post-it color-${data.colorIdx}`;
                let myTag = isMyPost(doc.id) ? '<div class="my-post-tag">ë‚´ ê¸€</div>' : '';
                post.innerHTML = `${myTag}<div class="post-emoji">${data.emotion}</div><div class="post-text">${data.text}</div><div class="post-author">From. ${data.author}</div><div id="badge-${doc.id}" class="comment-badge">ğŸ”” ëŒ“ê¸€ ë„ì°©!</div>`;
                post.onclick = () => {
                    openModal(viewModal);
                    currentDocId = doc.id; currentDocData = data;
                    document.getElementById('view-emotion').textContent = data.emotion;
                    document.getElementById('view-author').textContent = `ì‘ì„±ì: ${data.author}`;
                    document.getElementById('view-content').textContent = data.text;
                    document.getElementById('delete-btn').classList.remove('hidden');
                    document.getElementById('comment-section').classList.remove('hidden');
                    loadComments(doc.id); 
                };
                board.appendChild(post);
                if(isMyPost(doc.id)) checkComments(doc.id);
            });
        });

        function checkComments(postId) {
            db.collection('posts').doc(postId).collection('comments').onSnapshot(snap => {
                if(!snap.empty) {
                    const badge = document.getElementById(`badge-${postId}`);
                    if(badge) badge.style.display = 'block';
                    document.getElementById('header-noti').classList.add('noti-active');
                }
            });
        }

        btnAdmin.onclick = () => {
            const pw = prompt("ê´€ë¦¬ì ì•”í˜¸:");
            if (pw === "0929") {
                isAdminMode = !isAdminMode;
                btnAdmin.classList.toggle('admin-active', isAdminMode);
                showToast(isAdminMode ? "ğŸ‘‘ ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”" : "ê´€ë¦¬ì ëª¨ë“œ í•´ì œ");
            }
        };

        document.getElementById('submit-post').onclick = () => {
            let name = document.getElementById('writer-name').value.trim();
            let pw = document.getElementById('writer-pw').value.trim();
            const text = document.getElementById('post-text').value.trim();
            if(!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            db.collection('posts').add({
                emotion: selectedEmo, author: name || 'ìµëª…', password: pw || '0000', text: text,
                date: firebase.firestore.FieldValue.serverTimestamp(),
                colorIdx: Math.floor(Math.random() * 5)
            }).then((docRef) => { 
                saveMyPost(docRef.id);
                closeAllModals(); showToast("ë§ˆìŒì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨"); 
            });
        };

        document.getElementById('delete-btn').onclick = () => {
            if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
            db.collection('posts').doc(currentDocId).delete().then(() => { closeAllModals(); showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); });
        };

        document.getElementById('submit-comment').onclick = () => {
            const text = document.getElementById('c-text').value.trim();
            if(!text) return alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            db.collection('posts').doc(currentDocId).collection('comments').add({
                author: document.getElementById('c-name').value || 'ìµëª…', text: text,
                date: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('c-text').value = '';
                showToast("ì‘ì›ì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤! â¤ï¸");
            });
        };

        function loadComments(id) {
            if (unsubscribeComments) unsubscribeComments(); 
            const list = document.getElementById('comments-list');
            unsubscribeComments = db.collection('posts').doc(id).collection('comments').orderBy('date').onSnapshot(snap => {
                list.innerHTML = '';
                snap.forEach(d => {
                    const c = d.data();
                    const div = document.createElement('div');
                    div.className = 'comment-item';
                    div.innerHTML = `<div class="comment-content"><b>${c.author}:</b> <span>${c.text}</span></div>`;
                    list.appendChild(div);
                });
            });
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').catch(err => console.log(err));
            });
        }
    </script>
</body>
</html>